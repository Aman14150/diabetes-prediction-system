<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Diabetes Prediction</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <h2>ü©∫Diabetes Prediction System</h2>
            <ul>
                <li><a href="/" class="{% if not show_patients %}active{% endif %}">
                        <i class="fa-solid fa-vials"></i> Test</a>
                </li>
                <li><a href="/patients" class="{% if show_patients %}active{% endif %}">
                        <i class="fa-solid fa-users"></i> Patients</a>
                </li>
            </ul>
        </aside>

        <main class="content">
            {% if not show_patients %}
            <!-- Test Form -->
            <div class="card">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <h2>Predict Diabetes</h2>
                <div class="guidelines">
                    <strong>Guidelines:</strong><br>
                    - High Glucose (>140), BMI (>30) ‚Üí likely ‚ÄúDiabetic‚Äù<br>
                    - Normal Glucose (~100), BMI (~25), Age <35 ‚Üí likely ‚ÄúNon-Diabetic‚Äù<br>
                        - Fill all fields carefully for accurate prediction
                </div>

                <form id="diabetesForm" action="{{ url_for('predict') }}" method="post">
                    <div class="form-group">
                        <label for="name">Full Name:</label>
                        <input type="text" id="name" name="name" placeholder="Full Name" required>
                    </div>

                    <div class="form-group">
                        <label for="mobile">Mobile Number:</label>
                        <input type="tel" id="mobile" name="mobile" placeholder="Mobile Number" required>
                    </div>

                    <div class="form-group">
                        <label for="Pregnancies">Pregnancies (0-10)</label>
                        <input type="number" id="Pregnancies" name="Pregnancies" placeholder="Pregnancies" step="any"
                            required>
                    </div>

                    <div class="form-group">
                        <label for="Glucose">Glucose (80-180)</label>
                        <input type="number" id="Glucose" name="Glucose" placeholder="Glucose" step="any" required>
                    </div>

                    <div class="form-group">
                        <label for="BloodPressure">Blood Pressure (60-120)</label>
                        <input type="number" id="BloodPressure" name="BloodPressure" placeholder="Blood Pressure"
                            step="any" required>
                    </div>

                    <div class="form-group">
                        <label for="SkinThickness">Skin Thickness (10-50)</label>
                        <input type="number" id="SkinThickness" name="SkinThickness" placeholder="Skin Thickness"
                            step="any" required>
                    </div>

                    <div class="form-group">
                        <label for="Insulin">Insulin (15-276)</label>
                        <input type="number" id="Insulin" name="Insulin" placeholder="Insulin" step="any" required>
                    </div>

                    <div class="form-group">
                        <label for="BMI">BMI (18-35)</label>
                        <input type="number" id="BMI" name="BMI" placeholder="BMI" step="any" required>
                    </div>

                    <div class="form-group">
                        <label for="DiabetesPedigreeFunction">Diabetes Pedigree Function (0.1-2.5)</label>
                        <input type="number" id="DiabetesPedigreeFunction" name="DiabetesPedigreeFunction"
                            placeholder="DPF" step="any" required>
                    </div>

                    <div class="form-group">
                        <label for="Age">Age (20-80)</label>
                        <input type="number" id="Age" name="Age" placeholder="Age" step="any" required>
                    </div>

                    <div class="button-group">
                        <button type="submit" id="predictBtn">Predict</button>
                        <button type="button" id="clearBtn">Clear</button>
                    </div>
                </form>


                <div id="predictionResult" class="prediction">
                    {% if prediction_text %}
                    <span class="{% if prediction_text=='Diabetic' %}diabetic{% else %}non-diabetic{% endif %}">
                        {{ prediction_text }}
                    </span>
                    {% endif %}
                </div>
            </div>

            {% else %}
            <!-- Patients Table -->
            <div class="card">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}
                <h2>Patients List</h2>
                <div class="table-actions">
                    <input type="text" id="searchInput" placeholder="Search name/prediction...">
                    <a href="{{ url_for('export_csv') }}" class="button export">Export CSV</a>
                </div>

                <table id="patientsTable">
                    <thead>
                        <tr>
                            <th>Sr. No.</th>
                            {% for col in patient_columns[1:] %}
                            <th>{{ col|capitalize }}</th>
                            {% endfor %}
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in patient_data %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            {% for item in row[1:] %}
                            <td
                                class="{% if loop.last and item=='Diabetic' %}diabetic{% elif loop.last and item=='Non-Diabetic' %}non-diabetic{% endif %}">
                                {{ item }}
                            </td>
                            {% endfor %}
                            <td>
                                <form class="delete-form" action="{{ url_for('delete_patient', patient_id=row[0]) }}"
                                    method="post" style="display:inline;">
                                    <button type="button" class="delete-btn"
                                        onclick="showDeleteModal(this)">Delete</button>
                                </form>
                            </td>

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="pagination-wrapper">
                    <div class="pagination" id="pagination">
                        {% if page > 1 %}
                        <a href="{{ url_for('patients', page=page-1, per_page=per_page, search=search) }}">Prev</a>
                        {% endif %}
                        Page {{ page }} of {{ total_pages }}
                        {% if page < total_pages %} <a
                            href="{{ url_for('patients', page=page+1, per_page=per_page, search=search) }}">Next</a>
                            {% endif %}
                    </div>
                    <select id="perPageSelect" onchange="changePerPage()">
                        {% for n in [5,10,15,20] %}
                        <option value="{{ n }}" {% if per_page==n %}selected{% endif %}>{{ n }} per page</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to delete this patient?</p>
            <div class="modal-buttons">
                <button id="confirmDeleteBtn">Yes</button>
                <button onclick="closeModal()">No</button>
            </div>
        </div>
    </div>

    <script>
        // ----- Form Submit via AJAX -----
        const form = document.getElementById('diabetesForm');
        const predictionDiv = document.getElementById('predictionResult');

        form.addEventListener('submit', function (e) {
            e.preventDefault(); // page reload stop
            const formData = new FormData(form);

            fetch("{{ url_for('predict') }}", {
                method: "POST",
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    // Clear previous results/messages
                    predictionDiv.innerHTML = '';

                    if (data.status === 'success') {
                        const span = document.createElement('span');
                        span.textContent = data.result;
                        span.className = data.result === 'Diabetic' ? 'diabetic' : 'non-diabetic';
                        predictionDiv.appendChild(span);

                        // Auto-remove after 5 sec (optional)
                        setTimeout(() => predictionDiv.innerHTML = '', 10000);

                    } else if (data.status === 'error') {
                        data.messages.forEach(msg => {
                            const div = document.createElement('div');
                            div.className = 'flash error';
                            div.textContent = "‚ùå " + msg;
                            predictionDiv.appendChild(div);

                            // 5 sec me auto remove
                            setTimeout(() => div.remove(), 10000);
                        });
                    }
                })
                .catch(err => {
                    console.error("AJAX Error:", err);
                    const div = document.createElement('div');
                    div.className = 'flash error';
                    div.textContent = "‚ùå Something went wrong!";
                    predictionDiv.appendChild(div);
                    setTimeout(() => div.remove(), 10000);
                });
        });

        // ----- Clear Button -----
        document.getElementById('clearBtn').addEventListener('click', function () {
            form.reset();
            predictionDiv.innerHTML = '';
        });

        // ----- Delete Confirmation Modal -----
        let formToSubmit = null;

        function showDeleteModal(btn) {
            formToSubmit = btn.closest('form');
            document.getElementById('deleteModal').style.display = 'flex';
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (formToSubmit) {
                formToSubmit.submit();
            }
            closeModal();
        });

        function closeModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        // ----- Search Filter -----
        const searchInput = document.getElementById('searchInput');
        searchInput?.addEventListener('keyup', function () {
            const filter = this.value.toLowerCase();
            const table = document.getElementById('patientsTable');
            Array.from(table.tBodies[0].rows).forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const prediction = row.cells[row.cells.length - 2].textContent.toLowerCase();
                if (name.includes(filter) || prediction.includes(filter)) {
                    row.style.display = '';
                } else row.style.display = 'none';
            });
        });

        // ----- Change Per Page -----
        function changePerPage() {
            const perPage = document.getElementById('perPageSelect').value;
            window.location.href = "{{ url_for('patients') }}?per_page=" + perPage;
        }
    </script>

</body>

</html>